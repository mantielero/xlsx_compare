name: Create binaries

run-name: ${{ github.actor }} - creating the linux64 binary
on:
  push:
    # branches:
    #   - master
    tags:
      - "v*.*.*"

jobs:
    tests:
      runs-on: ${{ matrix.os }}
      strategy:
        matrix:
          nimversion:
            - binary:stable
          os:
            #- ubuntu-latest
            - windows-latest

      steps:
        #- uses: actions/checkout@v4
        - uses: actions/checkout@v3
        - name: Install Nim
          uses: iffy/install-nim@v5
          with:
            nim-version: ${{ matrix.nimversion }}
            repo-token: ${{ secrets.GITHUB_TOKEN }} 


        - name: Install the xlsx_compare package
          run: nimble install -y
        # - name: Compare the file
        #   run: nim c -d:release src/xlsx_compare

        - name: zip it
          if: matrix.os == 'ubuntu-latest'
          run: zip -j xlsx_compare_linux64.zip `readlink -f ~/.nimble/bin/xlsx_compare`
        
        - name: zip it
          if: matrix.os == 'windows-latest'
          run: |
            Get-Item "~/.nimble/bin/xlsx_compare.cmd" | Select-Object -ExpandProperty Target
            Compress-Archive -Path "~/.nimble/bin/xlsx_compare.cmd" -DestinationPath "xlsx_compare_win64.zip"
          # dir ~/.nimble/bin/
          #zip -j xlsx_compare_linux64.zip `readlink -f ~/.nimble/bin/xlsx_compare`
          #run: Compress-Archive -Path folder/* -Destination new.zip
 

        - name: Upload binaries to release
          uses: svenstaro/upload-release-action@v2
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: ./xlsx_compare_win64.zip
            #asset_name: xlsx_compare_$tag_linux64.zip
            asset_name: xlsx_compare_$tag_win64.zip
            tag: ${{ github.ref }}
            overwrite: true
            body: "Auto-released with Github actions"

        # - name: Deploy Windows release
        #   if: matrix.os == 'windows-latest'
        #   uses: WebFreak001/deploy-nightly@v3.1.0
        #   with:
        #     # https://api.github.com/repos/mantielero/xlsx_compare/releases
        #     upload_url: https://uploads.github.com/repos/Pure-D/serve-d/releases/20717582/assets{?name,label} # find out this value by opening https://api.github.com/repos/<owner>/<repo>/releases in your browser and copy the full "upload_url" value including the {?name,label} part
        #     release_id: 20717582 # same as above (id can just be taken out the upload_url, it's used to find old releases)
        #     asset_path: ./myapp.zip # path to archive to upload
        #     asset_name: myapp_windows-nightly-$$.zip # name to upload the release as, use $$ to insert date (YYYYMMDD) and 6 letter commit hash
        #     asset_content_type: application/zip # required by GitHub API
        #     max_releases: 7 # optional, if there are more releases than this matching the asset_name, the oldest ones are going to be deleted      